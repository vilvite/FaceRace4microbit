<!DOCTYPE html>
<html lang="nb">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#12d633" />
    <title>KI Kart Interface v3.6</title>
    <link rel="manifest" href="facerace-manifest.json">
    <link rel="shortcut icon" type="image/png" href="icon/fr128.png">

<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->
<!-- ‚ñà‚ñå                                                                     ‚ñê‚ñà -->
<!-- ‚ñà‚ñå   ____ ____ ____                 _         _                        ‚ñê‚ñà -->
<!-- ‚ñà‚ñå  / ___/ ___/ ___|       ___  ___| | _____ (_) ___  _ __   ___ _ __  ‚ñê‚ñà -->
<!-- ‚ñà‚ñå | |   \___ \___ \ _____/ __|/ _ \ |/ / __|| |/ _ \| '_ \ / _ \ '_ \ ‚ñê‚ñà -->
<!-- ‚ñà‚ñå | |___ ___) |__) |_____\__ \  __/   <\__ \| | (_) | | | |  __/ | | |‚ñê‚ñà -->
<!-- ‚ñà‚ñå  \____|____/____/      |___/\___|_|\_\___// |\___/|_| |_|\___|_| |_|‚ñê‚ñà -->
<!-- ‚ñà‚ñå                                         |__/                        ‚ñê‚ñà -->
<!-- ‚ñà‚ñå                                                                     ‚ñê‚ñà -->
<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->



<!-- Her er kode b√•de for farger og utseende, men ogs√• grafiske funksjoner og animasjoner som siden trenger for √• fungere. Utseende-greier ligger hovedsaklig √∏verst. -->
<!-- Engelske kommentarer er stort sett fra GPT-eksempler som har blitt flittig brukt tidlig i utviklingen  -->




<style> 
body {
    font-family: Verdana, sans-serif; /*  */
    text-align: center;
    margin: 0;
    padding: 0;
    
    
}

/* Title bar */
#title {
    text-align: center;
    padding: 16px;
    margin: 0;
}

/* Flex container ONLY for left/right */
#container {
    display: flex;
    flex-direction: row; /* desktop layout */
    min-height: calc(100vh - 64px); /* optional */
}

#left, #right {
    padding: 20px;
    text-align: left;
}

#left {
    flex: 1;
}

#right {
    flex: 2;
}

/*Yay, denne gj√∏r siden penere p√• mobil*/
@media (max-width: 768px) {
    #container {
        flex-direction: column;
    }

    #left,
    #right {
        width: 100%;
    }
}

/* Gradient Background, fargen som ligger i bunnen av siden */
body::after {
    content: "";
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 200px; /* Adjust as needed */
    background: linear-gradient(to top, #12d633, white); /* Denne fargegradienten matcher VilVites nettsidestil. */
    z-index: -1;
}


    /* Color Variables, p√•virker fargene p√• stolpediagrammet og slideren. Takk til Inspiria for denne biten, kjempefin! */
:root {
            --primary-color:   #12d633  ;
            --secondary-color:  #000000   ;
            --tertiary-color:   #4075ff   ;
            --quaternary-color:   #ffe000    ;
            --quinary-color:  #f2784b   ;
}



body::before { /* Denne legger vitensenterlogoen √∏verst i h√∏yre hj√∏rne p√• en ryddig m√•te */
    content: "";
    position: fixed;
    top: 10px; /* Adjust for exact placement */
    right: 10px;
    width: 91px; /* Adjust the size */
    height: 96px;
    background-image: url('images/VILVITE_logo_centered2.jpg'); /* Kuleste logoen. */
    background-size: cover;
    background-repeat: no-repeat;
    opacity: 0.6;
    z-index: -1; /* Push it behind all content */
    
}



/* Webcam Styling square. Endres med omhu! */
 #webcam {
    width: 90%;
    aspect-ratio: 1 / 1; 
    object-fit: cover; /* Ensures square cropping */
    transform: scaleX(-1); /* Start mirrored */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    border-radius: 15px;
  }




/*Utseende p√• knappene. Tror ikke alle brukes fortsatt.*/

#right button {
    
    font-family: Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji";

    display: block;
    width: 150px;
    margin: 5px auto;
    padding: 10px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
}

#right button:hover {
    background-color: #ddd;
}

#selectButtons {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 10px 0;
}

#selectButtons button {
  width: auto; /* Override the fixed width */
  margin: 0;   /* Remove inherited auto-centering */
}


/*Dette f√•r "Koble til Bluetooth"-knappen til √• gl√∏de om man mister kontakt med micro:biten. KAN legge til en auto-reconnect-funsksjon, men dette er g√∏yere.*/

    .flash-red {
        animation: flashRed 0.8s infinite;
    }

    @keyframes flashRed {
        0%   { background-color: red; }
        50%  { background-color: transparent; }
        100% { background-color: red; }
    }




#emojiBurstContainer { /*Sonen nederst hvor emojier spretter som konfetti*/
    position: fixed;
    bottom: 0;
    left : 0;
      width: 100%;
    pointer-events: none;
    overflow: visible;
      z-index: 9999;
    }

    .emoji-burst {
    position: absolute;
    font-size: 2rem;
    animation: burst 1s ease-out forwards;
    user-select: none;
    }

    @keyframes burst {
    0% {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
    100% {
        transform: translateY(-200px) scale(1.5) rotate(360deg);
        opacity: 0;
    }
    }



/* Her kommer bitene som f√•r stolpediagrammet til √• se s√• pent ut /*
/* Predictions Container */
        #predictionsContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
        }


        /* Prediction Styling */
        #predictionStatus, #predictionList {
            padding: 20px;
            width: 60%;
            background-color: rgba(61, 228, 83, 0.1); /* Light background for prediction area */

        }

        #predictionList, #thresholdContainer {
            visibility: hidden;
        }

        #predictionStatus {
            text-align: center;
            color: gray;
            font-style: italic;
        }

        
        /* Prediction List Styling */
        #predictionList {
            list-style: none;
        }

        /* prediction row: label, bar and percent on one line */
        .prediction-row {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .prediction-label {
            flex: 0 0 100px; /* fixed width for labels ‚Äî adjust as needed */
            text-align: right; /* align labels nicely */
            margin-right: 8px;
        }

        .bar-container {
            flex: 1 1 auto;
            background: rgba(0,0,0,0.06);
            height: 14px;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }
        
        .bar-fill {
            height: 100%;
            width: 0%;
            transition: width 400ms ease;
        }
        
        .prediction-percent {
            flex: 0 0 60px; /* fixed width for percentages */
            text-align: right;
        }


        /* Confidence threshold styling */
        #thresholdContainer {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0.6rem auto;
            padding: 8px;
            width: 80%;
            max-width: 560px;
        }

        /* label and percent */
        #thresholdContainer label {
            color: var(--primary-color);
            white-space: nowrap;
        }

        #thresholdValue {
            color: #333;
            min-width: 40px;
            text-align: right;
        }

        /* range slider base */
        #threshold {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 14px;                      /* same visual height as .bar-container */
            margin: 0;
            background: rgba(0,0,0,0.06);
            border-radius: 5px;
            outline: none;
            cursor: pointer;
            transition: box-shadow .12s ease;
        }

        /* WebKit: thumb & track */
        #threshold::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 5px;
            background: #fff;
            border: 2px solid var(--primary-color);
            box-shadow: 0 2px 6px rgba(0,0,0,0.18);
            margin-top: -3px; /* center the thumb on the track */
        }
        


/* LEGGER GAMMEL, UBRUKT KODE HER FOR REFERANSE */

/* Drag & Drop Zone. Ikke lenger i bruk, gjorde heller stolpediagrammet klikkbart og lot hele siden ta i mot .zip-filer */
#dropZone {
    border: 2px dashed #007bff;
    padding: 20px;
    margin: 20px auto;
    width: 80%;
    background-color: #f8f9fa;
    cursor: pointer;
}

#dropZone:hover {
    background-color: #e2e6ea;
}

/* Popup styling. Testet ut √• ha popup med informasjon, men den ble rotete og un√∏dvendig. */
.popup {
    display: none;
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
}

.popup-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    width: 50%;
    min-width: 300px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.close {
    float: right;
    font-size: 24px;
    cursor: pointer;
}

/* Textarea styling */
textarea {
    width: 100%;
    height: 100px;
    margin: 10px 0;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    resize: none;
    font-size: 16px;
}

</style> 
</head> 







<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->
<!-- ‚ñà‚ñå                                                                   ‚ñê‚ñà -->
<!-- ‚ñà‚ñå  _   _ _____ __  __ _        ___               _      __          ‚ñê‚ñà -->
<!-- ‚ñà‚ñå | | | |_   _|  \/  | |      / / |__   ___   __| |_   _\ \         ‚ñê‚ñà -->
<!-- ‚ñà‚ñå | |_| | | | | |\/| | |     / /| '_ \ / _ \ / _` | | | |\ \  _____ ‚ñê‚ñà -->
<!-- ‚ñà‚ñå |  _  | | | | |  | | |___  \ \| |_) | (_) | (_| | |_| |/ / |_____|‚ñê‚ñà -->
<!-- ‚ñà‚ñå |_| |_| |_| |_|  |_|_____|  \_\_.__/ \___/ \__,_|\__, /_/         ‚ñê‚ñà -->
<!-- ‚ñà‚ñå  ___  ___| | _____ (_) ___  _ __   ___ _ __      |___/            ‚ñê‚ñà -->
<!-- ‚ñà‚ñå / __|/ _ \ |/ / __|| |/ _ \| '_ \ / _ \ '_ \                      ‚ñê‚ñà -->
<!-- ‚ñà‚ñå \__ \  __/   <\__ \| | (_) | | | |  __/ | | |                     ‚ñê‚ñà -->
<!-- ‚ñà‚ñå |___/\___|_|\_\___// |\___/|_| |_|\___|_| |_|                     ‚ñê‚ñà -->
<!-- ‚ñà‚ñå                  |__/                                             ‚ñê‚ñà -->
<!-- ‚ñà‚ñå                                                                   ‚ñê‚ñà -->
<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->




<body> 

<h1 id="title">Face Race testside tjollahoppsannsa! Hvis du leser dette har noe g√•tt i stykker </h1>  <!-- Dette feltet endres av oversettelsefunksjonen som autokj√∏rer n√•r siden lastes. Fungerer som debugging lol -->


<div id="container">
    <div id="left">
        
        <!-- Proper squared?-->
        
        <label for="cameraSelect">Select Camera:</label>
        <select id="cameraSelect"></select>
        <button onclick="refreshCameraList()">üîÑ Refresh List</button>
        <button onclick="toggleMirror()">üîÑ Mirror Video</button> <!-- Mirror Button -->
        <br>                
        <br><br>
        <video id="webcam" autoplay playsinline></video>
        <canvas id="mirrorCanvas" hidden></canvas>
        <br>

    <!--    KNAPPER FOR OVERSETTELSE - satt p√• pause enn s√• lenge. Ble litt mas √• finne ut hvordan jeg skulle oppdatere tekst p√• alle de nye fine feltene.
        
    <div id="selectButtons">
        <button onclick="switchLanguage('en')">üá¨üáß English</button>
        <button onclick="switchLanguage('no')">üá≥üá¥ Norsk</button>
        </div>   

    -->
         
       
                     
    </div>
   

    <div id="right">
        
        <!-- Instruksjoner -->

        <div id="instructionsTitle"><h1>Instructions:</h1></div>
        
        <div id="instructionsText1"><i>1) Lag en modell med</i> <a href="https://teachablemachine.withgoogle.com/train/image" target="_blank"> teachablemachine.withgoogle.com</a> og last den ned som .zip.</div>
        <br>
        <div id="instructionsText2"><i></i></div>
        <br>
            
       <!--! Fjernet denne! Var et felt hvor man kunne drag&droppe filene, eller klikke p√• for √• √•pne filutforsker for √• bla. N√• kan hele siden ta imot zipfiler, og stolpediagrammet kan klikkes istedet.
       <div style="text-align: center;">
       <div id="dropZone">Drag & Drop Model ZIP Here</div></div style>
        <input type="file" id="fileInput" style="display:none;" accept=".zip">
        -->
        
        <div id="instructionsText3"><i></i></div>
        <div id="selectButtons">
        <button id="connectButton">Connect to Micro:bit USB serial</button>
        <!-- <button id="pairingButton">Pair Bluetooth</button> Rester fra tidlig tidlig testing. Viser seg at ting g√•r fryktelig fryktelig gale om man pr√∏ver √• PAIRE micro:biten (a+b+reset) som en del av tilkoblingen med web-bluetooth. Nesten flaks at jeg fikk det til i det hele tatt slik jeg holdt p√•. -->
        <button id="connectButtonBT">Connect to Micro:bit Bluetooth</button>
        </div>
        <br>
        
        <!-- Predictions -->
        

        <div id="predictionsContainer">
            
            <!-- Prediction Status & List -->
            <div class="text-block" id="predictionStatus">Ingen modell lastet. Klikk her for √• √•pne filutforsker.</div>
            <div id="predictionList"></div>
            <input type="file" id="fileInput" style="display:none;" accept=".zip">

            <!-- Confidence Threshold Slider -->
            <div class="text-block" id="thresholdContainer">
                <label for="threshold">Confidence threshold</label>
                <input type="range" id="threshold" min="0" max="100" step="4" value="68"> <!-- Fordi jeg syns det er kjempemorsomt at det da akkurat ikke g√•r an √• sette den til 67 eller 69 -->
                <span id="thresholdValue">50</span>%
            </div>

        <br>

        <!-- SUPER DUPER HANDY INFORMASJONSLOGG!  -->
        <h2>Status</h2> 
        <div id="output" style="background-color: black; color: white; padding: 10px; font-family: monospace; height: 100px; overflow-y: scroll;"></div> 


        <h2>Tilgjengelige kameraer:</h2>
        <pre id="deviceList">Loading...</pre>
        

        <div id="instructionsText4"><i></i></div>
        <br>
        <div id="instructionsText5"><i></i></div>
        <br>
        <div id="instructionsText6"><i></i></div>
        <div id="selectButtons">
        <button id="demoLink" onclick=" window.open('https://makecode.microbit.org/#pub:_Yj9UbEEyf8qW','_blank')">Kode-eksempel USB</button>
        <button id="demoLinkBT" onclick=" window.open('https://makecode.microbit.org/#pub:_dg9WXzWMTXga','_blank')">Kode-eksempel Bluetooth</button> <!-- N√• leder denne til et program som FUNKER.-->
        <button id="connectButtonBTYOLO">Reservetilkobling: Ufiltrert Bluetooth</button>
       
    </div>
    <br>
    <br>

    <h3>v3.5 <a href="https://vilvite.github.io/FaceRace4microbit/bitbotremote.html"> -</a> 21.01.26</h3>
    </div>
</div>









<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->
<!-- ‚ñà‚ñå                                                                               ‚ñê‚ñà -->
<!-- ‚ñà‚ñå  ____            _       _                 _         _                        ‚ñê‚ñà -->
<!-- ‚ñà‚ñå / ___|  ___ _ __(_)_ __ | |_      ___  ___| | _____ (_) ___  _ __   ___ _ __  ‚ñê‚ñà -->
<!-- ‚ñà‚ñå \___ \ / __| '__| | '_ \| __|____/ __|/ _ \ |/ / __|| |/ _ \| '_ \ / _ \ '_ \ ‚ñê‚ñà -->
<!-- ‚ñà‚ñå  ___) | (__| |  | | |_) | ||_____\__ \  __/   <\__ \| | (_) | | | |  __/ | | |‚ñê‚ñà -->
<!-- ‚ñà‚ñå |____/ \___|_|  |_| .__/ \__|    |___/\___|_|\_\___// |\___/|_| |_|\___|_| |_|‚ñê‚ñà -->
<!-- ‚ñà‚ñå                   |_|                             |__/                        ‚ñê‚ñà -->
<!-- ‚ñà‚ñå                                                                               ‚ñê‚ñà -->
<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->




<!-- TensorFlow.js & JSZip -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.0.0/dist/tf.min.js"></script> <!-- Jeg tror kanskje ikke de to √∏verste her trengs?? Fors√∏kte f√∏rst √• gj√∏re alt fra grunnen av med TensorFlow, men Teachable Machine hadde alle funksjonene for seg selv. TODO: Fjern og se om ting g√•r i stykker. -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@3.0.0/dist/tf-converter.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- Kan og lastes ned og legges i /lib for offline-versjon. Kjekt om man f.eks. har ferdige modeller liggende. TODO: Lag en autorun-funksjon som laster inn en demo-modell. M√• 
<script src="/lib/tf.min.js"></script>
<script src="/lib/tf-converter.min.js"></script>
<script src="/lib/teachablemachine-image.min.js"></script>
<script src="/lib/jszip.min.js"></script>
-->

<script>
let model, webcamElement, classNames, writer, connectedUSB = false, connectedBT = false, lastClassSent = null; currentStream = null;
let isMirrored = true; // Track mirroring stat

//BT stuff here
let microbitDevice;
let microbitServer;
let microbitService;
let microbitCharacteristic;

const btSendQueue = [];
let btSendingInProgress = false;



//    _      _      _      _      _      _      _      _      _      _      _      _      _   
//  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_ 
// (_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)
//  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_) 
//    _                                                                                   _   
//  _( )_    _  _____                          _      _ _       _     _ _               _( )_ 
// (_ o _)  | |/ /_ _|     _ __ ___   ___   __| | ___| | |     | |__ (_) |_ ___ _ __   (_ o _)
//  (_,_)   | ' / | |_____| '_ ` _ \ / _ \ / _` |/ _ \ | |_____| '_ \| | __/ _ \ '_ \   (_,_) 
//    _     | . \ | |_____| | | | | | (_) | (_| |  __/ | |_____| |_) | | ||  __/ | | |    _   
//  _( )_   |_|\_\___|    |_| |_| |_|\___/ \__,_|\___|_|_|     |_.__/|_|\__\___|_| |_|  _( )_ 
// (_ o _)                                                                             (_ o _)
//  (_,_)                                                                               (_,_) 
//    _      _      _      _      _      _      _      _      _      _      _      _      _   
//  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_  _( )_ 
// (_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)(_ o _)
//  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_)  (_,_) 


// Request permissions and list cameras
async function getCameras() {
            try {
                // Request camera access to get full labels
                await navigator.mediaDevices.getUserMedia({ video: true });

                // Now list devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                if (videoDevices.length === 0) {
                    document.getElementById("deviceList").textContent = "No cameras found.";
                    return;
                }

                const select = document.getElementById("cameraSelect");
                select.innerHTML = ""; // Clear old options

                let deviceInfo = "";

                videoDevices.forEach((device, index) => {
                    const option = document.createElement("option");
                    option.value = device.deviceId;
                    option.textContent = device.label || `Camera ${index + 1}`;
                    select.appendChild(option);

                    deviceInfo += `üì∑ ${device.label || "Unknown Camera"};\nID: ${device.deviceId}\n\n`;
                });

                document.getElementById("deviceList").textContent = deviceInfo;
                

                // Auto-select first camera
                if (videoDevices.length > 0) {
                    setupWebcam(videoDevices[0].deviceId);
                }

            } catch (error) {
                console.error("Error accessing cameras:", error);
                document.getElementById("deviceList").textContent = "‚ö†Ô∏è Cannot access cameras. Check permissions.";
            }
        }

        // Switch to selected camera
        async function setupWebcam(deviceId) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop()); // Stop old stream
            }

            try {
                const constraints = { video: { deviceId: { exact: deviceId } } };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById("webcam").srcObject = stream;
                currentStream = stream;
                webcamElement = stream;
            } catch (error) {
                console.error("Error switching camera:", error);
            }
        }

        // Listen for dropdown change
        document.getElementById("cameraSelect").addEventListener("change", (event) => {
            setupWebcam(event.target.value);
});

// Refresh camera list
function refreshCameraList() {
    getCameras();
}

function toggleMirror() {
    isMirrored = !isMirrored;
    const videoElement = document.getElementById("webcam");
    videoElement.style.transform = isMirrored ? "scaleX(-1)" : "scaleX(1)"; // ‚úÖ Flip preview
}



// Load Model from ZIP using tmImage.loadFromFiles. Dette er hovedgrunnen til at prosjektet startet i utgangspunktet. Opplasting i sky p√• Teachablemaskin funket driiiiiitd√•rlig, en m√•te √• laste ned og bruke .zipfiler h√∏rtes ut til √• v√¶re en bedre l√∏sning.
async function handleZipUpload(file) {
    const zip = new JSZip();
    const zipData = await zip.loadAsync(file);

    const modelJSONFile = zipData.file("model.json");
    const metadataJSONFile = zipData.file("metadata.json");
    const weightsFile = zipData.file("weights.bin");

    if (!modelJSONFile || !metadataJSONFile || !weightsFile) {
        console.error("‚ùå Model files missing in ZIP!");
        return;
    }

    const modelJSON = await modelJSONFile.async("string");
    const metadataJSON = await metadataJSONFile.async("string");
    const weightsData = await weightsFile.async("arraybuffer");

    // Create File objects required by tmImage.loadFromFiles
    const modelFile = new File([modelJSON], "model.json", { type: "application/json" });
    const weightsFileObj = new File([weightsData], "weights.bin", { type: "application/octet-stream" });
    const metadataFile = new File([metadataJSON], "metadata.json", { type: "application/json" });

    try {
            // Remove "Model not loaded" status, if present
            const statusEl = document.getElementById("predictionStatus");
            if (statusEl) statusEl.remove();
            
            model = await tmImage.loadFromFiles(modelFile, weightsFileObj, metadataFile);
            classNames = await model.getClassLabels();
            console.log("‚úÖ Model loaded successfully with classes:", classNames);
            document.getElementById("predictionList").style.visibility = "visible";
            document.getElementById("thresholdContainer").style.visibility = "visible";
        } catch (error) {
            console.error("‚ùå Error loading tmImage model:", error);
            document.getElementById("predictionStatus").textContent = "‚ùå Error loading model.";
        }
}


// File Input for selecting ZIP file through a dialog
const fileInput = document.getElementById("fileInput");

// Handle file selection
fileInput.addEventListener("change", async () => {
    const file = fileInput.files[0];
    if (file && file.name.endsWith(".zip")) {
        console.log("üìÇ ZIP file selected:", file.name);
        await handleZipUpload(file);
    } else {
        alert("Please select a valid ZIP file.");
    }
});

// Click or Drag & Drop Upload Handler
const dropZone = document.getElementById("predictionStatus");
dropZone.addEventListener("click", () => {
    fileInput.click();
});
dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = "#e2e6ea";
});
dropZone.addEventListener("dragleave", () => {
    dropZone.style.backgroundColor = "#f8f9fa";
});
dropZone.addEventListener("drop", async (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = "#f8f9fa";

    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith(".zip")) {
        console.log("üìÇ ZIP file received:", file.name);
        await handleZipUpload(file);
    } else {
        alert("Velg en gyldig .zip-fil (f.eks. tm-my-image-model.zip).");
    }
});

// Utvidet til √• ta imot drag&drops p√• hele siden

document.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = "#e2e6ea";
});

document.addEventListener("dragleave", (e) => {
    // only reset when leaving the window
    if (e.relatedTarget === null) {
        dropZone.style.backgroundColor = "#f8f9fa";
    }
});

document.addEventListener("drop", async (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = "#f8f9fa";

    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith(".zip")) {
        console.log("üìÇ ZIP file received:", file.name);
        await handleZipUpload(file);
    } else {
        alert("Velg en gyldig .zip-fil (f.eks. tm-my-image-model.zip).");
    }
});



// Convert non-ASCII characters - skandinaviske tegn funker ikke p√• serieport, dette fikser at √Ü√ò√Ö blir tomme felt i micro:biten.
function convertToASCIICompatible(str) {
    const replacements = {
        '√Ü': 'AE', '√ò': 'OE', '√Ö': 'AA',
        '√¶': 'ae', '√∏': 'oe', '√•': 'aa',
    };
    return str.split('').map(char => replacements[char] || char).join('');
}



// Update UI with predictions
    function updateUI(prediction) {
        const predictionList = document.getElementById("predictionList");
        predictionList.innerHTML = "";

        // get color variables from :root and build a cycling array
        const rootStyles = getComputedStyle(document.documentElement);
        const colorVars = ['--primary-color', '--secondary-color', '--tertiary-color', '--quaternary-color', '--quinary-color'];
        const colors = colorVars.map(v => rootStyles.getPropertyValue(v).trim() || '#cccccc');

        // sort alphabetically by className (case-insensitive)
        const sorted = prediction.slice().sort((a, b) =>
            a.className.toLowerCase().localeCompare(b.className.toLowerCase())
        );

        sorted.forEach(({ className, probability }, idx) => {
            const li = document.createElement("li");
            li.className = "prediction-item text-block";

            const row = document.createElement("div");
            row.className = "prediction-row";

            // label (colored to match bar)
            const label = document.createElement("span");
            label.className = "prediction-label";
            const color = colors[idx % colors.length];
            label.textContent = className;
            label.style.color = color;

            // bar
            const barContainer = document.createElement("div");
            barContainer.className = "bar-container";

            const fill = document.createElement("div");
            fill.className = "bar-fill";
            fill.style.background = color;
            fill.style.width = (probability * 100) + "%";
            fill.setAttribute("role", "progressbar");
            fill.setAttribute("aria-valuemin", "0");
            fill.setAttribute("aria-valuemax", "100");
            fill.setAttribute("aria-valuenow", Math.round(probability * 100));

            barContainer.appendChild(fill);

            // percent
            const percentSpan = document.createElement("span");
            percentSpan.className = "prediction-percent";
            percentSpan.textContent = Math.round(probability * 100) + "%";

            // assemble: label | bar (flex) | percent
            row.appendChild(label);
            row.appendChild(barContainer);
            row.appendChild(percentSpan);

            li.appendChild(row);
            predictionList.appendChild(li);
        });
        document.getElementById("thresholdValue").textContent = document.getElementById("threshold").value;
    }



/* GAMMEL BIT ~~~~~~~~~~~~~~

// Update UI with predictions
function updateUI(prediction) {
    const predictionList = document.getElementById("predictionList");
    predictionList.innerHTML = "";
    prediction.forEach(({ className, probability }) => {
        const listItem = document.createElement("li");
        listItem.textContent = `${className}: ${(probability * 100).toFixed(2)}%`;
        predictionList.appendChild(listItem);
    });
    document.getElementById("thresholdValue").textContent = document.getElementById("threshold").value;
}
GAMMEL BIT ~~~~~~  */  


//Run Prediction
async function predict() {
    const videoElement = document.getElementById("webcam");

    if (!model || videoElement.videoWidth === 0 || videoElement.videoHeight === 0) {
        console.warn("‚ö†Ô∏è Waiting for webcam...");
        requestAnimationFrame(predict);
        return;
    }

   // console.log("üîç Running prediction..."); //Denne ble spammy √• ha med i loggen.

    try {
        const maxPredictions = model.getTotalClasses();
        const predictionData = await model.predictTopK(videoElement, maxPredictions, isMirrored);

        if (!predictionData || predictionData.length === 0) {
            console.error("‚ö†Ô∏è Model returned empty prediction");
            return;
        }

        updateUI(predictionData);

        // Process prediction results
        const threshold = document.getElementById("threshold").value / 100;
        const topPrediction = predictionData[0];

        if (topPrediction.probability >= threshold) {
            const className = topPrediction.className;

            if (className !== lastClassSent) {
                lastClassSent = className;

                if (connectedUSB) sendDataToMicrobitUSB(`${className}\n`);
                if (connectedBT) sendDataToMicrobitBT(`${className}\n`);
            }
        }
    } catch (error) {
        console.error("‚ùå Prediction Error:", error);
    }

    await new Promise(resolve => setTimeout(resolve, 50));
    requestAnimationFrame(predict);
}


    // Update slider visual fill and value label
    function updateThresholdUI() {
        const input = document.getElementById("threshold");
        const value = Number(input.value);
        // paint filled portion with gradient matching prediction bars
        input.style.background = `linear-gradient(90deg, ${getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim()} ${value}%, rgba(0,0,0,0.06) ${value}%)`;
        document.getElementById("thresholdValue").textContent = value;
    }

    // wire up events
    const thresholdInput = document.getElementById("threshold");
    if (thresholdInput) {
        thresholdInput.addEventListener("input", updateThresholdUI);
        // initialize appearance on load
        updateThresholdUI();
    }





//  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\ 
// //\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\
// \\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\// Bluetooth i Chrome og Edge er kjempeg√∏y! Man kan hoppe over hele sender-mottaker-kodingen. Sparer tid og krefter n√•r fokuset skal v√¶re p√•
//  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  KI og Teachable Machine. V√¶r OBS p√• at iOS-enheter tilsynelatende ikke tillater denne funksjonen. Android g√•r greit. 
//  /\                                                                              /\  
// //\\   ____  _            _              _   _           _     _ _              //\\ For at BT skal virke, m√• micro:biten ha Bluetooth-utvidelsen i stedet for Radio. Man m√• ogs√• klikke p√• tannhjulet oppe til h√∏yre i MakeCode og 
// \\//  | __ )| |_   _  ___| |_ ___   ___ | |_| |__       | |__ (_) |_ ___ _ __   \\// "Innstillinger for prosjekt", s√• velge "Ingen sammenkobling trengs: Alle kan koble til via bl√•tann."
//  \/   |  _ \| | | | |/ _ \ __/ _ \ / _ \| __| '_ \ _____| '_ \| | __/ _ \ '_ \   \/  Programmet m√• ogs√• ha blokken "bl√•tann serieport-tjeneste (UART)" ved start.
//  /\   | |_) | | |_| |  __/ || (_) | (_) | |_| | | |_____| |_) | | ||  __/ | | |  /\ 
// //\\  |____/|_|\__,_|\___|\__\___/ \___/ \__|_| |_|     |_.__/|_|\__\___|_| |_| //\\ Dersom micro:biten ikke syns, sjekk at den IKKE er paret med enheten du bruker, og skru den av i noen sekunder. 
// \\//                                                                            \\// Pr√∏v ogs√• √• stenge nettleservinduet. 
//  \/                                                                              \/ 
//  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  /\  Les mer om micro:bit og BT her https://lancaster-university.github.io/microbit-docs/ble/profile/
// //\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\
// \\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//
//  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/  \/ 





// Connect to Micro:bit over serial. Vanlig USB-tilkobling, ezpz.
document.getElementById("connectButton").addEventListener("click", async () => {
    try {
        const microbit = await navigator.serial.requestPort();
        await microbit.open({ baudRate: 115200 });
        writer = microbit.writable.getWriter();
        connectedUSB = true;
        console.log("‚úÖ Connected to Micro:bit!");
    } catch (error) {
        console.error("‚ùå Error connecting to Micro:bit:", error);
    }
});

/*Trekker oppmerksomheten mot tilkoblingsknappen om micro:biten blir koblet fra, som f.eks. ved nedlasting av nytt program*/

function handleUSBDisconnect() {
    connectedUSB = false;
    writer = null;
    console.log("‚ö†Ô∏è micro:bit USB disconnected");
    document.getElementById('connectButtonBT').disabled = false;
    if (!connectButton) return;
    connectButton.classList.add("flash-red");
}




document.getElementById("connectButtonBT").addEventListener("click", async () => {
    
    if (microbitDevice?.gatt?.connected) {  //koble fra gamle koblinger for √• hindre at listen t√∏mmes
        microbitDevice.gatt.disconnect();
    } 

        resetBluetoothSendState();  // ‚≠ê critical, wow GPT dette ser seri√∏st ut. Emoji og greier.
    try {
        console.log("Requesting micro:bit Bluetooth device...");
        microbitDevice = await navigator.bluetooth.requestDevice({
           // acceptAllDevices: true // Allow any Bluetooth device, no filters
            filters: [{ namePrefix: "BBC micro:bit" }], // Only show micro:bit devices
            optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e'] // Nordic UART Service (NUS)
        });
        
        // ‚≠ê Lagt til i 3.5
        microbitDevice.addEventListener("gattserverdisconnected", () => {
            console.warn("üîå Bluetooth disconnected");
            console.error("üîå Connection lost");
            connectedBT = false;
            microbitCharacteristic = null;
            handleBluetoothDisconnected();
            resetBluetoothSendState();
        });


        console.log("Connecting to GATT Server...");
        microbitServer = await microbitDevice.gatt.connect();
        console.log("Awaiting Primary Service");
        microbitService = await microbitServer.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
        console.log("Finding TX Characteristic...");
        microbitCharacteristic = await microbitService.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e'); // TX characteristic, chatGPT mente f√∏rst at RX var rett
        console.log("Connected to", microbitDevice.name, " via Bluetooth");
        connectedBT = true;
        document.getElementById('connectButton').disabled = true;
        connectButtonBT.classList.remove("flash-red");
        
    } catch (log) {
        console.log("Bluetooth connection failed, ", log);
        
        
    }
});


// legger til funksjon for √• stenge tilkoblinger, dette var siste puslebrikke for √• f√• BT til √• bli stabil <3
window.addEventListener("beforeunload", () => {
    if (microbitDevice?.gatt?.connected) {
        microbitDevice.gatt.disconnect();
    }
});


function handleBluetoothDisconnected() { // Trekker brukerens oppmerksomhet diskr√©t mot tilkoblingsknappen om micro:biten mister kontakt.
    if (!connectButtonBT) return;
    document.getElementById('connectButton').disabled = false;
    connectButtonBT.classList.add("flash-red");
}



// Dersom man ikke lenger ser micro:biten, kan man bruke testknapp nederst p√• siden for ufiltrert tilkobling. Kjekk for feils√∏king og √• se hvor mye BT-trafikk det er i n√¶rheten.
document.getElementById("connectButtonBTYOLO").addEventListener("click", async () => {

     if (microbitDevice?.gatt?.connected) {  //koble fra gamle koblinger for √• hindre at listen t√∏mmes
        microbitDevice.gatt.disconnect();
}
    try {
        console.log("Requesting micro:bit Bluetooth device...");
        microbitDevice = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true, // Allow any Bluetooth device, no filters 
            //filters: [{ namePrefix: "BBC micro:bit" }], // Only show micro:bit devices
            optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e'] // Nordic UART Service (NUS)
        });
        
        console.log("Connecting to GATT Server...");
        microbitServer = await microbitDevice.gatt.connect();
        console.log("Awaiting Primary Service");
        microbitService = await microbitServer.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
        console.log("Finding TX Characteristic...");
        microbitCharacteristic = await microbitService.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e'); // TX characteristic, chatGPT mente f√∏rst at RX var rett 
        console.log("Connected to", microbitDevice.name, " via Bluetooth");
        connectedBT = true;
        document.getElementById('connectButton').disabled = true;
        connectButtonBT.classList.remove("flash-red");
        } catch (log) {
        console.log("Bluetooth connection failed, ", log);
        
        }
});

// Send data over serial
async function sendDataToMicrobitUSB(signal) {
    if (!writer) {
        console.error("‚ùå No writer available to send data.");
        return;
    }
    try {
        const signalToSend = convertToASCIICompatible(signal);
        console.log("üì° Sending:", signalToSend);
        for (let i = 0; i < signalToSend.length; i++) {
            const byte = new TextEncoder().encode(signalToSend[i]);
            await writer.write(byte);
        }
        showEmojiBurst();
    } catch (error) {
        console.error("‚ùå Error sending data:", error);
    }
}

// Ny funksjon, sender signalene i k√∏ s√• man kan pr√∏ve p√• nytt om noe g√•r poff
async function sendDataToMicrobitBT(signal) {
    if (!microbitCharacteristic) {
        console.error("‚ùå No BT connection thingy available to send data");
        return;
    }

    const signalToSend = convertToASCIICompatible(signal) + "\n";
    btSendQueue.push(signalToSend);

    if (!btSendingInProgress) {
        processBTSendQueue();
    }
}

function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Ny funksjon for √• sende signalene i k√∏ og orden

async function processBTSendQueue() {
    if (btSendQueue.length === 0) {
        btSendingInProgress = false;
        showEmojiBurst();
        return;
    }

    btSendingInProgress = true;
    const message = btSendQueue[0]; // don‚Äôt remove yet

    try {
        console.log("üì° Sending:", message.trim());
        const data = new TextEncoder().encode(message);
        await microbitCharacteristic.writeValue(data);

        // success ‚Üí remove message
        btSendQueue.shift();

        // small pause improves micro:bit stability
        await delay(20);

    } catch (error) {
        if (
            error.name === "NetworkError" &&
            error.message.includes("GATT operation already in progress")
        ) {
            // BLE stack busy ‚Üí retry same message shortly
            await delay(40);
        } else if (
            error.name === "NetworkError" &&
            error.message.includes("GATT Server is disconnected")
        ) {
            handleBluetoothDisconnected();
            return;
        } else {
            console.error("‚ùå Error sending data:", error);
            // drop the message to avoid deadlock
            btSendQueue.shift();
        }
    }

    processBTSendQueue();
}

// trengte ogs√• en funksjon for √• t√∏mme k√∏en n√•r man mister tilkobling

function resetBluetoothSendState() {
    btSendQueue.length = 0;          // clear queue
    btSendingInProgress = false;     // release lock
}





/* Dette er den gamle, bytter ut med ny som skal fikse k√∏
//more fancy sendDataToMicroBit(BT)
async function sendDataToMicrobitBT(signal) {
    if (!microbitCharacteristic) {
        console.error("‚ùå No BT connection thingy available to send data");
        return;
    }
    try {
        const signalToSend = convertToASCIICompatible(signal);
        console.log("üì° Sending:", signalToSend);
        for (let i = 0; i < signalToSend.length; i++) {
            const byte = new TextEncoder().encode(signalToSend[i]);
            await microbitCharacteristic.writeValue(byte);
        }
        showEmojiBurst();
    } catch (error) {
        console.error("‚ùå Error sending data:", error);

    if (
        error.name === "NetworkError" &&
        error.message.includes("GATT Server is disconnected")
    ) {
        handleBluetoothDisconnected();
    }

    }
}
    

*/

/*
// copypaste fra test-eksempel, tar vare p√• for referanse
document.getElementById('sendButton').addEventListener('click', async () => {
    if (!microbitCharacteristic) {
        alert("Not connected to micro:bit");
        return;
    }
    const message = "HELLO\n"; // Ensure newline is included
    try {
        console.log("Sending:", message);
        await microbitCharacteristic.writeValue(new TextEncoder().encode(message));
        console.log("Message sent: HELLO");
    } catch (error) {
        console.error("Failed to send message", error);
    }
});

*/




//  _____                                                                    _____ 
// ( ___ )                                                                  ( ___ )
//  |   |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|   | 
//  |   |                                                                    |   | 
//  |   |   _____                                                            |   | 
//  |   |  |  ___|_ _ _ __   ___ _   _                                       |   | 
//  |   |  | |_ / _` | '_ \ / __| | | |                                      |   | 
//  |   |  |  _| (_| | | | | (__| |_| |                                      |   | 
//  |   |  |_|_ \__,_|_| |_|\___|\__, |                                 __   |   | 
//  |   |   / _|_   _ _ __ | | __|___(_) ___  _ __   ___ _ __   _ __   (())  |   | 
//  |   |  | |_| | | | '_ \| |/ / __|| |/ _ \| '_ \ / _ \ '__| | '_ \ / _ '| |   | 
//  |   |  |  _| |_| | | | |   <\__ \| | (_) | | | |  __/ |    | |_) | (_| | |   | 
//  |   |  |_|  \__,_|_| |_|_|\_\___// |\___/|_| |_|\___|_|    | .__/ \__,_| |   | 
//  |   |   ___(_) __| | ___ _ __  |__/                        |_|           |   | 
//  |   |  / __| |/ _` |/ _ \ '_ \                                           |   | 
//  |   |  \__ \ | (_| |  __/ | | |                                          |   | 
//  |   |  |___/_|\__,_|\___|_| |_|                                          |   | 
//  |   |                                                                    |   | 
//  |   |                                                                    |   | 
//  |___|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|___| 
// (_____)                                                                  (_____)



    // Emoji Burst Animation, Inspiria sin var MYE festligere enn mine gule lyn! Endret rekkef√∏lgen til √• matche fargeprofilen i designmanualen v√•r :D
    function showEmojiBurst() {
        const container = document.getElementById("emojiBurstContainer");
        const emojis = [

            // gr√∏nn (#7AB800)
            "ü§¢", "üê∏", "üçè", "üçÄ", "üëΩ",

            //  hvit (#f0ab00)
            "ü•º", "üèê", "ü•ö", "üßª", "‚òÅ",

            // svart (#7AB800)
            "üé©", "üñ§", "üåë", "üß•", "üï∂Ô∏è",

            //  bl√• (#3db7e4)
            "üëñ", "üíß", "üê¨", "üåä", "‚ùÑÔ∏è",

            //  gul (#f0ab00)
            "‚ö°", "üåü", "üôÉ", "üéá", "ü•é"



        ];
        const chosenEmoji = emojis[Math.floor(Math.random() * emojis.length)];

        for (let i = 0; i < 12; i++) {
            const emoji = document.createElement("div");
            emoji.className = "emoji-burst";
            emoji.innerText = chosenEmoji;

            // Random horizontal position (from 10% to 90%)
            emoji.style.left = Math.random() * 80 + 10 + "%";

            // Slight animation delay for variation
            emoji.style.animationDelay = (Math.random() * 0.3).toFixed(2) + "s";

            container.appendChild(emoji);

            // Remove after animation completes
            setTimeout(() => emoji.remove(), 1000);
        }
    }



// Console log stuff here. Tungvint √• m√•tte trykke p√• F12 for √• se etter feil, spesielt siden Fn-lock gj√∏r det til russisk rulett om man skrur PCen i dvale eller ikke.
const outputElement = document.getElementById("output");

        // 1. Unified function to handle different log levels
        function addToOutput(message, type = 'log') {
            const entry = document.createElement('div');
            entry.className = `log-msg log-${type}`;
            
            // Format: [TIMESTAMP] [TYPE] Message
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            
            outputElement.appendChild(entry);
            outputElement.scrollTop = outputElement.scrollHeight;
        }

        // 2. Capture standard logs
        const originalLog = console.log;
        console.log = function(...args) {
            addToOutput(args.join(' '), 'log');
            originalLog.apply(console, args);
        };

        // 3. Capture error logs
        const originalError = console.error;
        console.error = function(...args) {
            addToOutput(args.join(' '), 'error');
            originalError.apply(console, args);
        };

        // 4. Global Listener for actual runtime crashes (e.g. syntax/reference errors)
        window.onerror = function(msg, url, line) {
            console.error(`${msg} (Line: ${line})`);
            return false;
        };


        // Example usage (this output will now appear in the <div>)
        console.log(`Live console log start: ${new Date().toLocaleTimeString()}`);




// Oversettelsesbit : TODO √• fikse denne opp igjen. Ble for mange nye felter √• holde styr p√• n√•r jeg oppdaterte hele UIen i versjon 3. 

const translations = {
    en: {
        title: "Face Race with Teachable Machine and micro:bit",
        cameraSelector: "Camera Selector",
        selectCamera: "Select Camera:",
        refreshList: "üîÑ Refresh List",
        toggleMirror: "üîÑ Mirror Video",
        availableCameras: "Available Cameras:",
        predictions: "Predictions:",
        thresholdLabel: "Threshold (Confidence):",
        connectButton: "Connect with USB Serial",
        connectButtonBT: "Connect with Bluetooth",
       // dropZone: "Drag & Drop Model ZIP Here",
        instructionsTitle: "Instructions:",
        instructionsText1: "1) Create a model with teachablemachine.withgoogle.com and download as .zip. ",
        instructionsText2: "2) Drag&Drop the .zip onto the next field, or click and select the file.",
        instructionsText3: "3) press Connect to micro:bit and select your unit. Must be using Chrome or Edge!",
        instructionsText4: "Your micro:bit should now receive the Class names over USB or Bluetooth! Adjust the Confidence Threshold to suit your needs.",
        instructionsText5: "If something breaks, press F12 and check the console for errors.",
        instructionsText6: "Inspired by Steamlabs make: AI Robots. Questions? Comments? Feel free to contact me at ah@vilvite.no"
    },
    no: {
        title: "KI Kart med Teachable Machine og micro:bit",
        cameraSelector: "Kameravelger",
        selectCamera: "Velg kamera:",
        refreshList: "üîÑ Oppdater liste",
        toggleMirror: "üîÑ Speilvend video",
        availableCameras: "Tilgjengelige Kameraer:",
        predictions: "Modell-tolking:",
        thresholdLabel: "Terskel (Sikkerhet):",
        connectButton: "Koble til med USB Serial",
        connectButtonBT: "Koble til med Bluetooth",
      //  dropZone: "Dra og slipp ZIP-fil av modell her",
        instructionsTitle: "Instruksjoner:",
  //      instructionsText1: "1) Lag en modell med teachablemachine.withgoogle.com og last den ned som .zip.",
        instructionsText2: "2) Last inn modellen ved √• dra og slippe .zip-filen inn p√• denne siden, eller klikk p√• det gr√∏nne feltet under for √• lete.",
        instructionsText3: "3) Trykk en av Koble til-knappene, og velg riktig enhet i vinduet som dukker opp (NB! Bruk Chrome eller Edge.).",
        instructionsText4: "micro:biten din skal n√• motta Klasse-navnene som signaler over USB eller Bl√•tann! Still inn Terskel-bryteren til √∏nsket skr√•sikkerhet. ",
        instructionsText5: "BLUETOOTH: Dersom micro:biten ikke vises i det hele tatt, pr√∏v √• skru den av i 2 sekunder og last inn siden p√• nytt. S√• kan du pr√∏ve √• laste inn eksempel-koden under. Sjekk og at micro:biten IKKE er pairet med enheten din. Du kan og teste Ufiltrert Tilkobling-knappen under og se om den dukker opp der.",
        instructionsText6: "Inspirert av Steamlabs make: AI Robots. Sp√∏rsm√•l, forslag eller kommentarer? Ikke n√∏l med √• sende meg en epost p√• ah@vilvite.no. Takk til Inspiria Science Center for innspill!"
    }
};        

function switchLanguage(lang) {
    
    // Oppdater venstre felt

    document.querySelector("h1").innerText = translations[lang].title;
  //  document.querySelector("#left h2").innerText = translations[lang].availableCameras;
  //  document.querySelector("#left h1").innerText = translations[lang].cameraSelector;

    document.querySelector("label[for='cameraSelect']").innerText = translations[lang].selectCamera;
    document.querySelector("button[onclick='refreshCameraList()']").innerText = translations[lang].refreshList;
    document.querySelector("button[onclick='toggleMirror()']").innerText = translations[lang].toggleMirror;
    document.querySelector("#deviceList").innerText = translations[lang].availableCameras;
 //   document.querySelector("#predictions h2").innerText = translations[lang].predictions;
    document.querySelector("label[for='threshold']").innerText = translations[lang].thresholdLabel;    
    document.querySelector("#connectButton").innerText = translations[lang].connectButton;
    document.querySelector("#connectButtonBT").innerText = translations[lang].connectButtonBT;
  //  document.querySelector("#dropZone").innerText = translations[lang].dropZone;

    // Oppdater h√∏yre felt

  
    document.querySelector("#instructionsTitle h1").innerText = translations[lang].instructionsTitle;
  //  document.querySelector("#instructionsText1").innerHTML = `<i>${translations[lang].instructionsText1}</i>`;
    document.querySelector("#instructionsText2").innerHTML = `<i>${translations[lang].instructionsText2}</i>`;
    document.querySelector("#instructionsText3").innerHTML = `<i>${translations[lang].instructionsText3}</i>`;
    document.querySelector("#instructionsText4").innerHTML = `<i>${translations[lang].instructionsText4}</i>`;
    document.querySelector("#instructionsText5").innerHTML = `<i>${translations[lang].instructionsText5}</i>`;
    document.querySelector("#instructionsText6").innerHTML = `<i>${translations[lang].instructionsText6}</i>`;

}

// Testet popup-vinduer med info / kodeeksempler, men syns det ble mye bedre √• ha knapper som lenket rett til kode-eksemplene i stedet. Har koden liggende for referanse.
function openPopup() {
    document.getElementById("popup").style.display = "flex";
}

function closePopup() {
    document.getElementById("popup").style.display = "none";
}

function copyText() {
    let textArea = document.getElementById("popupText");
    textArea.select();
    textArea.setSelectionRange(0, 99999); // For mobile devices
    document.execCommand("copy");
    alert("Copied to clipboard!");
}





// Start Everything
async function init() {
    switchLanguage('no') // Hvis noe har g√•tt g√¶li, vil ikke denne kj√∏re, og overskriften √∏verst p√• siden ser veldig rar ut.
    await getCameras();
    predict();
}
init();


if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js');
  });
}



</script>

<div id="emojiBurstContainer"></div>
</body>

<!-- https://www.asciiart.eu/text-to-ascii-art for √• lage g√∏ye skriblerier-->

</html>


